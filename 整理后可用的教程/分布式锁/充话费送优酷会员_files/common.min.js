'use strict';

(function ($) {
    window.common = {
        tip: function tip(msg) {
            var tipHtml = '<div class="tip"><i class="iconfont-chat icon-chattishi mr5"></i>' + msg + '</div>';
            $('body').append(tipHtml);
            setTimeout(function () {
                $('.tip').addClass('ani');
                setTimeout(function () {
                    $('.tip').remove();
                }, 2000);
            }, 100);
        },
        chatModal: function chatModal(title, oktext, cb) {
            var modalHtml = '<div class="modal">' + '<div class="modal-title"><i class="iconfont-chat icon-chatgantanhao"></i>' + title + '</div>' + '<div class="modal-footer">' + '<button type="button" id="btnCancel" class="btn btn-line">取消</button>' + '<button type="button" id="btnOk" class="btn btn-blue ml10">' + oktext + '</button>' + '</div>' + '</div>';
            $('body').append(modalHtml);

            setTimeout(function () {
                $('.modal').addClass('ani');
            }, 100);

            $('body').on('click', '#btnCancel', function () {
                $('.modal').remove();
            });
            $('body').on('click', '#btnOk', function () {
                cb && cb();
                $('.modal').remove();
            });
        },

        uploadTipModal: function uploadTipModal(title, cb) {
            var modalHtml = '<div class="modal">' + '<div class="modal-title"><i class="iconfont-chat icon-chatgantanhao"></i>' + title + '</div>' + '<div class="modal-footer">' + '<button type="button" id="btnCancel" class="btn btn-line">取消</button>' + '<button type="button" class="btn btn-blue ml10">重新选择<input id="btnUpload" type="file"></button>' + '</div>' + '</div>';
            $('body').append(modalHtml);

            setTimeout(function () {
                $('.modal').addClass('ani');
            }, 100);

            $('body').on('click', '#btnCancel', function () {
                $('.modal').remove();
            });
            $('body').on('change', '#btnUpload', function (e) {
                cb && cb(e);
            });
        },
        loadingShow: function loadingShow(context) {
            context = context ? context : '';
            var loadingHtml = '<div id="loading" class="loading">' + '<div class="loading-box"><img src="https://chong2c.santiyun.com/assets/images/loading.svg" width="30" height="30" style="margin-bottom:.2rem" alt="">' + context + '' + '</div>' + '</div>';
            if ($('#loading').length == 0) {
                $('body').append(loadingHtml);
            }
        },
        loadingHide: function loadingHide() {
            if ($('#loading').length > 0) {
                $('#loading').remove();
            }
        },
        ajax: function ajax(url, p, settings) {
            var defaults = {
                type: 'get',
                async: true,
                success: function success() {},
                complete: function complete(jqXHR, textStatus) {},
                error: function error(code, msg) {
                    common.tip(msg);
                    $('#spin').length > 0 && $('#spin').hide();
                }
            };
            settings = $.extend(defaults, settings);
            // common.loadingShow();

            //从地址栏取参数（区分渠道的，比如：3482696B07B84B1B 联通 华为）
            if (common.getQuery('digest')) {
                p.digest = common.getQuery('digest');
            }
            p.timestamp = parseInt(new Date().getTime() / 1000);

            var sortP = common.objKeySort(p); //console.log(sortP)

            var pStr = '';
            for (var i in sortP) {

                if (sortP[i] == undefined) continue;

                if (i == 'sign') continue;
                pStr += i + encodeURIComponent(sortP[i]);
            }
            p.sign = md5(pStr + '6c41a870b54abb78efc9874475612345').toLocaleLowerCase();

            console.log(pStr, 'pStr===');
            $.ajax({
                //cache: false,
                async: settings.async,
                url: url,
                type: settings.type,
                data: p,
                //headers:{'sign':md5(pStr)},
                dataType: 'json',
                success: function success(result) {
                    common.loadingHide();
                    if (result.code == 0 || result.code == 1000) {
                        settings.success(result);
                    } else {
                        //console.log(result,'code不是0')
                        settings.error(result.code, result.message || result.msg, result);
                    }
                },
                complete: function complete(jqXHR, textStatus) {
                    settings.complete(jqXHR, textStatus);
                    //common.loadingHide();
                },
                error: function error(jqXHR, textStatus, errorThrown) {
                    settings.error(-1, textStatus);
                    common.loadingHide();
                }
            });
        },
        ajaxNosign: function ajaxNosign(url, p, settings) {
            var defaults = {
                type: 'get',
                success: function success() {},
                complete: function complete(jqXHR, textStatus) {},
                error: function error(code, msg) {
                    common.tip(msg);
                    $('#spin').length > 0 && $('#spin').hide();
                }
            };
            settings = $.extend(defaults, settings);
            // common.loadingShow();

            //从地址栏取参数（区分渠道的，比如：3482696B07B84B1B 联通 华为）
            if (common.getQuery('digest')) {
                p.digest = common.getQuery('digest');
            }

            $.ajax({
                //cache: false,
                url: url,
                type: settings.type,
                data: p,
                dataType: 'json',
                success: function success(result) {
                    common.loadingHide();
                    if (result.code == 0 || result.code == 1000) {
                        settings.success(result);
                    } else {
                        //console.log(result,'code不是0')
                        settings.error(result.code, result.message || result.msg, result);
                    }
                },
                complete: function complete(jqXHR, textStatus) {
                    settings.complete(jqXHR, textStatus);
                    //common.loadingHide();
                },
                error: function error(jqXHR, textStatus, errorThrown) {
                    settings.error(-1, textStatus);
                    common.loadingHide();
                }
            });
        },
        ajax2: function ajax2(url, p, settings) {
            var defaults = {
                type: 'get',
                success: function success() {},
                complete: function complete(jqXHR, textStatus) {},
                error: function error(code, msg) {
                    common.tip(msg);
                }
            };
            settings = $.extend(defaults, settings);
            // common.loadingShow();
            var sortP = common.objKeySort(p);
            var pStr = '';
            for (var i in sortP) {
                pStr += i + '=' + sortP[i];
            }
            //console.log(pStr,'pStr===')
            $.ajax({
                //cache: false,
                url: url,
                type: settings.type,
                data: p,
                headers: { 'sign': md5(pStr) },
                dataType: 'json',
                success: function success(result) {
                    //common.loadingHide();
                    if (result.code == 200) {
                        settings.success(result.data, result);
                    } else {
                        settings.error(result.code, result.message, result);
                    }
                },
                complete: function complete(jqXHR, textStatus) {
                    settings.complete(jqXHR, textStatus);
                },
                error: function error(jqXHR, textStatus, errorThrown) {
                    settings.error(-1, textStatus);
                    common.loadingHide();
                }
            });
        },
        getQuery: function getQuery(name, url) {
            if (url && url.indexOf('#') > -1) {
                url = url.replace('#', '');
            }
            var _s = window.location.search;
            if (url) {
                var aa = document.createElement('a');
                aa.href = url;
                _s = aa.search;
            }
            var result = _s.match(new RegExp("[\?\&][^\?\&]+=[^\?\&]+", "g"));

            if (result == null) {
                return '';
            }
            for (var i = 0; i < result.length; i++) {
                var keyValue = result[i].substring(1).split("=");
                result[keyValue[0]] = unescape(decodeURI(keyValue[1]));
            }
            return name ? result[name] : result;
        },
        objKeySort: function objKeySort(obj) {
            var newkey = Object.keys(obj).sort();
            var newObj = {};
            for (var i = 0; i < newkey.length; i++) {
                newObj[newkey[i]] = obj[newkey[i]];
            }
            return newObj;
        },
        videoRingTrack: function videoRingTrack(p, cb) {
            p.provinceName = localStorage.getItem('areaName');
            common.ajax2('https://v-vcrbt.santiyun.com/material/userOperSave', p, {
                success: function success(data) {
                    cb && cb();
                }
            });
        }
    };

    window.digest = common.getQuery('digest');
})(jQuery);